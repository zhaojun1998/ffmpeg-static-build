name: Build and Release Static FFmpeg

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

env:
  IMAGE_NAME: static-ffmpeg
  BUILD_DIR: ~/build

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest,ubuntu-latest-arm64 ]
        version: [ '5.0','5.1','6.0' ]
        include:
          - os: ubuntu-latest
            arch: amd64
          - os: ubuntu-latest-arm64
            arch: arm64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Build Docker Image
        run: |
          DOCKER_BUILDKIT=1 docker build --build-arg FFMPEG_VERSION=${{ matrix.version }} --output type=local,dest=${BUILD_DIR}/ffmpeg-${{ matrix.version }} -t ${IMAGE_NAME} .
      - name: Package Build Directory
        run: |
          tar -czvf ffmpeg-${{ matrix.version }}-linux-${{ matrix.arch }}.tar.gz ${BUILD_DIR} -C ffmpeg-${{ matrix.version }}
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ffmpeg-${{ matrix.version }}-linux-${{ matrix.arch }}.tar.gz
          tag: ${{ github.ref }}
          overwrite: true
